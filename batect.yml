containers:
  build-env:
    image: meltano/meltano:v2.4.0-python3.10
    working_directory: /new_project
    run_as_current_user:
      enabled: true
      home_directory: /home/container-user
    volumes:
      - local: ./new_project
        container: /new_project
        options: cached
      - local: ./source
        container: /new_project/source
        options: cached
  
  moto:
    image: motoserver/moto:4.0.0
    ports:
      - local: 5005
        container: 5000
  
  aws_cli:
    image: amazon/aws-cli:2.7.25
    volumes:
      - local: ./csvs
        container: /csvs
        options: cached

  postgres:
    image: postgres:13.4-bullseye
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
      POSTGRES_DB: demo
    ports:
      - local: 5432
        container: 5432

tasks:
  ## Utility tasks
  version:
    description: Display version 
    group: Utility tasks
    run:
      container: build-env
      command: --version

  launch_mock:
    description: Launch the AWS S3 mock (moto), its UI, fill it with CSVs and initiate the postgres.
    group: Utility tasks
    dependencies:
      - moto
      - postgres
    run:
      container: aws_cli
      entrypoint: sh -c '/csvs/stuff.sh'
